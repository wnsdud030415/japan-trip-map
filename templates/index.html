<!DOCTYPE html>
<html>
<head>
    <title>ì¹œêµ¬ë“¤ê³¼ ì¼ë³¸ ì—¬í–‰ ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body, html { height: 100%; margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; }
        
        /* ì§€ë„ ì „ì²´ í™”ë©´ */
        #map { height: 100%; width: 100%; }
        
        /* ë²„íŠ¼ë“¤ì´ ë“¤ì–´ê°ˆ ë°•ìŠ¤ */
        #controls {
            position: absolute;
            top: 60px; /* ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ì°½ ë“±ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ */
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 25px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex;
            gap: 5px;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .filter-btn {
            border: none;
            background: #f0f0f0;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        /* ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .filter-btn.active {
            background: #333;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ë²”ë¡€(Legend) ìŠ¤íƒ€ì¼ */
        #legend {
            background: white;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            font-size: 12px;
            position: absolute;
            bottom: 30px; 
            left: 10px; 
            z-index: 999;
        }
        .legend-item { margin-bottom: 5px; display: flex; align-items: center; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; display: inline-block; }
    </style>
</head>
<body>
    <div id="controls">
        <button class="filter-btn active" onclick="filterMap('all')">ì „ì²´ë³´ê¸°</button>
        <button class="filter-btn" onclick="filterMap('namba')">ì˜¤ì‚¬ì¹´(ë‚œë°”)</button>
        <button class="filter-btn" onclick="filterMap('kyoto')">êµí† </button>
    </div>

    <div id="map"></div>
    
    <div id="legend">ë¡œë”© ì¤‘...</div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADJIrnLeiIBYBiOzi795TNF3KRsZdgBwA&callback=initMap" async defer></script>

    <script>
        let map;
        let markers = []; // ê°€ê²Œ ë§ˆì»¤ë“¤ì„ ë‹´ì•„ë‘˜ ë¦¬ìŠ¤íŠ¸
        let accMarkers = {}; // ìˆ™ì†Œ ë§ˆì»¤ë“¤ì„ ë‹´ì•„ë‘˜ ë¦¬ìŠ¤íŠ¸

        async function initMap() {
            // FastAPIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const response = await fetch("/api/data");
            const data = await response.json();
            const accs = data.accommodations;

            // 1. ì§€ë„ ìƒì„± (ì´ˆê¸° ìœ„ì¹˜ëŠ” ë‚œë°”)
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: accs.namba.lat, lng: accs.namba.lon },
                zoom: 10, // ì „ì²´ê°€ ë³´ì´ê²Œ ì ë‹¹íˆ ì¤Œ ì•„ì›ƒ
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            // 2. ìˆ™ì†Œ ë§ˆì»¤ ì°ê¸° (ë³„ ëª¨ì–‘)
            const starIcon = "http://maps.google.com/mapfiles/kml/shapes/star.png"; // ë³„ ì•„ì´ì½˜ ì´ë¯¸ì§€

            // ë‚œë°” ìˆ™ì†Œ
            accMarkers['namba'] = new google.maps.Marker({
                position: { lat: accs.namba.lat, lng: accs.namba.lon },
                map: map,
                title: accs.namba.name,
                icon: { url: starIcon, scaledSize: new google.maps.Size(30, 30) }, // ì•„ì´ì½˜ í¬ê¸° ì¡°ì ˆ
                zIndex: 9999
            });

            // êµí†  ìˆ™ì†Œ
            accMarkers['kyoto'] = new google.maps.Marker({
                position: { lat: accs.kyoto.lat, lng: accs.kyoto.lon },
                map: map,
                title: accs.kyoto.name,
                icon: { url: starIcon, scaledSize: new google.maps.Size(30, 30) },
                zIndex: 9999
            });

            // 3. ì¹œêµ¬ë“¤ ë§ˆì»¤ ì•„ì´ì½˜ ì„¤ì •
            const icons = {
                'red': 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                'blue': 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                'green': 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                'yellow': 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
                'purple': 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'
            };

            const legendDiv = document.getElementById('legend');
            legendDiv.innerHTML = `<strong>ì¹œêµ¬ë“¤ í”½</strong><br>`;

            // 4. ì¹œêµ¬ë“¤ ë°ì´í„° ë£¨í”„ ëŒë©´ì„œ ë§ˆì»¤ ìƒì„±
            data.friends.forEach(friend => {
                // ë²”ë¡€ ì¶”ê°€
                legendDiv.innerHTML += `
                    <div class="legend-item">
                        <span class="dot" style="background:${friend.color}"></span> ${friend.name}
                    </div>
                `;

                friend.places.forEach(place => {
                    const marker = new google.maps.Marker({
                        position: { lat: place.lat, lng: place.lon },
                        map: map, // ì²˜ìŒì—” ì§€ë„ì— ë‹¤ ë³´ì—¬ì¤Œ
                        title: place.name,
                        icon: icons[friend.color] || icons['red']
                    });

                    // â˜…ì¤‘ìš”: í•„í„°ë§ì„ ìœ„í•´ ë§ˆì»¤ì— ì§€ì—­ ì •ë³´ë¥¼ ì‹¬ì–´ë‘ â˜…
                    marker.region = place.region; 

                    // í´ë¦­í–ˆì„ ë•Œ ë‚˜ì˜¤ëŠ” ì •ë³´ì°½ ë‚´ìš©
                    const contentString = `
                        <div style="min-width:200px; padding:5px;">
                            <h3 style="margin:0 0 5px 0; font-size:16px;">${place.name}</h3>
                            <p style="margin:0; font-size:13px; color:#555;">ì¶”ì²œì¸: <b>${friend.name}</b></p>
                            <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
                            <p style="margin:0; font-size:13px;">
                                ${place.region === 'namba' ? 'ë‚œë°”' : 'êµí† '} ìˆ™ì†Œì—ì„œ 
                                <span style="color:red; font-weight:bold;">${place.distance}km</span>
                            </p>
                            ${place.link ? `<a href="${place.link}" target="_blank" style="display:block; margin-top:8px; text-decoration:none; color:#007bff; font-weight:bold;">ğŸ“ êµ¬ê¸€ë§µì—ì„œ ë³´ê¸°</a>` : ''}
                        </div>
                    `;

                    const infoWindow = new google.maps.InfoWindow({ content: contentString });

                    // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ ì—´ê¸°
                    marker.addListener("click", () => {
                        infoWindow.open(map, marker);
                    });

                    // ë§ˆì»¤ ê´€ë¦¬ ë¦¬ìŠ¤íŠ¸ì— ì €ì¥
                    markers.push(marker);
                });
            });
        }

        // 5. ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•„í„°ë§ í•¨ìˆ˜
        function filterMap(region) {
            // ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ ë¡œì§
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // 1. ëª¨ë“  ì¹œêµ¬ ë§ˆì»¤ë“¤ì„ ê²€ì‚¬
            markers.forEach(marker => {
                if (region === 'all' || marker.region === region) {
                    marker.setMap(map); // ì§€ë„ì— í‘œì‹œ
                } else {
                    marker.setMap(null); // ì§€ë„ì—ì„œ ìˆ¨ê¹€
                }
            });

            // 2. ìˆ™ì†Œ ë§ˆì»¤ì™€ ì¹´ë©”ë¼ ì´ë™ ë¡œì§
            if (region === 'all') {
                // ì „ì²´ë³´ê¸°: ìˆ™ì†Œ ë‘˜ ë‹¤ ë³´ì—¬ì£¼ê³ , ì¤Œ ì•„ì›ƒ
                accMarkers['namba'].setMap(map);
                accMarkers['kyoto'].setMap(map);
                map.setZoom(10);
                map.panTo(accMarkers['namba'].getPosition()); // ëŒ€ì¶© ë‚œë°” ìª½ìœ¼ë¡œ ì´ë™
            } else {
                // íŠ¹ì • ì§€ì—­ ë³´ê¸°: í•´ë‹¹ ì§€ì—­ ìˆ™ì†Œë§Œ ë³´ì—¬ì£¼ê³  ì¤Œ ì¸
                
                // ë‚œë°” ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
                if (region === 'namba') {
                    accMarkers['namba'].setMap(map);
                    accMarkers['kyoto'].setMap(null); // êµí†  ìˆ™ì†Œ ìˆ¨ê¹€
                    map.panTo(accMarkers['namba'].getPosition());
                    map.setZoom(14); // ê°€ê¹ê²Œ ì¤Œì¸
                }
                // êµí†  ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
                else if (region === 'kyoto') {
                    accMarkers['kyoto'].setMap(map);
                    accMarkers['namba'].setMap(null); // ë‚œë°” ìˆ™ì†Œ ìˆ¨ê¹€
                    map.panTo(accMarkers['kyoto'].getPosition());
                    map.setZoom(14); // ê°€ê¹ê²Œ ì¤Œì¸
                }
            }
        }
    </script>
</body>
</html>