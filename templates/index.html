<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Japan Trip Map 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- ê¸°ë³¸ ì„¤ì • --- */
        * { box-sizing: border-box; }
        body, html { 
            height: 100%; margin: 0; padding: 0; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            overflow: hidden; 
        }

        #map { height: 100%; width: 100%; z-index: 0; }

        /* --- ìƒë‹¨ í•„í„° ë°” --- */
        #top-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 15px 10px;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0) 100%);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none;
        }
        #top-bar::-webkit-scrollbar { display: none; }

        .chip-btn {
            background: white;
            border: 1px solid #eee;
            border-radius: 20px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        
        .chip-btn.active {
            background: #222; color: white; border-color: #222;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* ëœë¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .random-btn {
            background: #FF6B6B; color: white; border: none;
        }
        .random-btn:active { transform: scale(0.95); background: #ee5253; }

        /* --- ìš°ì¸¡ í•˜ë‹¨ GPS ë²„íŠ¼ --- */
        #gps-btn {
            position: absolute; bottom: 30px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: #4285F4; color: white; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 20px; z-index: 20; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        #gps-btn:active { transform: scale(0.95); background: #3367D6; }

        /* --- ì¢Œì¸¡ í•˜ë‹¨ ë²”ë¡€ --- */
        #legend-card {
            position: absolute; bottom: 30px; left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 10px 14px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 10; max-width: 150px; font-size: 12px;
            max-height: 200px; overflow-y: auto;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; color: #555; }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

        /* --- ì •ë³´ì°½ ì»¤ìŠ¤í…€ --- */
        .info-card { padding: 5px 0; min-width: 200px; }
        .info-card h3 { margin: 0 0 5px 0; font-size: 16px; font-weight: 700; color: #222; }
        .info-card .tag { 
            display: inline-block; padding: 2px 6px; border-radius: 4px; 
            font-size: 10px; color: white; margin-bottom: 8px; font-weight: bold;
        }
        .info-card p { margin: 4px 0; font-size: 13px; color: #555; }
        
        /* ê¸¸ì°¾ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-link {
            display: block; margin-top: 10px;
            background: #4285F4; color: white;
            text-align: center; padding: 10px 0;
            border-radius: 8px; text-decoration: none;
            font-size: 14px; font-weight: 600;
            box-shadow: 0 2px 5px rgba(66, 133, 244, 0.3);
        }
        .btn-link:active { background: #3367D6; transform: translateY(1px); }
    </style>
</head>
<body>

    <div id="top-bar">
        <button class="chip-btn random-btn" onclick="pickRandom()">
            <i class="fa-solid fa-dice"></i> ë­ ë¨¹ì§€?
        </button>
        <button class="chip-btn active" onclick="filterMap('all', this)">
            <i class="fa-solid fa-layer-group"></i> ì „ì²´
        </button>
        <button class="chip-btn" onclick="filterMap('namba', this)">
            <i class="fa-solid fa-city"></i> ë‚œë°”
        </button>
        <button class="chip-btn" onclick="filterMap('kyoto', this)">
            <i class="fa-solid fa-torii-gate"></i> êµí† 
        </button>
    </div>

    <div id="map"></div>

    <div id="legend-card">
        <div style="font-weight:700; margin-bottom:8px;">ì¹œêµ¬ë“¤ Pick</div>
        <div id="legend-content">ë¡œë”© ì¤‘...</div>
    </div>

    <button id="gps-btn" onclick="getMyLocation()">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>

    <script>
        let map;
        let markers = [];
        let accMarkers = {}; 
        let myLocationMarker = null;

        async function initMap() {
            try {
                const response = await fetch("/api/data");
                const data = await response.json();
                const accs = data.accommodations;

                // ì§€ë„ ìƒì„±
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: accs.namba.lat, lng: accs.namba.lon },
                    zoom: 11,
                    disableDefaultUI: true, // ê¸°ë³¸ UI ì œê±°
                    zoomControl: true,
                    styles: [ { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] } ]
                });

                // ìˆ™ì†Œ ë§ˆì»¤
                const starIcon = "http://maps.google.com/mapfiles/kml/shapes/star.png"; 
                accMarkers['namba'] = createMarker(accs.namba, starIcon, "namba");
                accMarkers['kyoto'] = createMarker(accs.kyoto, starIcon, "kyoto");

                const icons = {
                    'red': 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    'blue': 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                    'green': 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    'yellow': 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
                    'purple': 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'
                };

                const legendContent = document.getElementById('legend-content');
                legendContent.innerHTML = '';

                // ë°ì´í„° ë£¨í”„
                data.friends.forEach(friend => {
                    legendContent.innerHTML += `
                        <div class="legend-item">
                            <span class="dot" style="background:${friend.color}"></span> ${friend.name}
                        </div>
                    `;

                    friend.places.forEach(place => {
                        const marker = new google.maps.Marker({
                            position: { lat: place.lat, lng: place.lon },
                            map: map,
                            icon: icons[friend.color] || icons['red']
                        });
                        marker.region = place.region; 

                        // ê¸¸ì°¾ê¸° ë§í¬ ìƒì„±
                        const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${place.lat},${place.lon}&travelmode=walking`;

                        const contentString = `
                            <div class="info-card">
                                <span class="tag" style="background:${friend.color}">${friend.name} Pick</span>
                                <h3>${place.name}</h3>
                                <p><i class="fa-solid fa-hotel"></i> ìˆ™ì†Œì—ì„œ <b>${place.distance}km</b></p>
                                
                                <a href="${directionsUrl}" target="_blank" class="btn-link">
                                    <i class="fa-solid fa-person-walking"></i> ê¸¸ì°¾ê¸° (Go)
                                </a>
                            </div>
                        `;
                        
                        const infoWindow = new google.maps.InfoWindow({ content: contentString });
                        marker.addListener("click", () => {
                            infoWindow.open(map, marker);
                            marker.setAnimation(null);
                        });
                        markers.push(marker);
                    });
                });
            } catch (error) {
                console.error("ë§µ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
            }
        }

        // ìˆ™ì†Œ ë§ˆì»¤ ìƒì„±ê¸°
        function createMarker(info, iconUrl, region) {
            const marker = new google.maps.Marker({
                position: { lat: info.lat, lng: info.lon },
                map: map,
                icon: { url: iconUrl, scaledSize: new google.maps.Size(35, 35) },
                zIndex: 100
            });
            const infoWin = new google.maps.InfoWindow({ content: `<div style="padding:5px"><b>ğŸ  ${info.name}</b></div>` });
            marker.addListener("click", () => infoWin.open(map, marker));
            return marker;
        }

        // ë‚´ ìœ„ì¹˜ ì°¾ê¸°
        function getMyLocation() {
            const btn = document.getElementById('gps-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; 

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = { lat: position.coords.latitude, lng: position.coords.longitude };
                    if (myLocationMarker) myLocationMarker.setMap(null);

                    myLocationMarker = new google.maps.Marker({
                        position: pos, map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE, scale: 8,
                            fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2,
                        },
                        zIndex: 999
                    });
                    map.setCenter(pos);
                    map.setZoom(15);
                    btn.innerHTML = '<i class="fa-solid fa-location-arrow"></i>';
                }, () => {
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    btn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>';
                });
            } else { alert("GPS ë¯¸ì§€ì› ë¸Œë¼ìš°ì €"); }
        }

        // ëœë¤ ë½‘ê¸°
        function pickRandom() {
            const visibleMarkers = markers.filter(m => m.getMap() !== null);
            if (visibleMarkers.length === 0) { alert("í‘œì‹œëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤!"); return; }

            const randomIndex = Math.floor(Math.random() * visibleMarkers.length);
            const selectedMarker = visibleMarkers[randomIndex];

            map.panTo(selectedMarker.getPosition());
            map.setZoom(16);
            
            selectedMarker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(() => { selectedMarker.setAnimation(null); }, 2100); 

            google.maps.event.trigger(selectedMarker, 'click');
        }

        // í•„í„°ë§
        function filterMap(region, btnElement) {
            document.querySelectorAll('.chip-btn').forEach(btn => {
                if(!btn.classList.contains('random-btn')) btn.classList.remove('active');
            });
            if(btnElement) btnElement.classList.add('active');

            markers.forEach(marker => {
                marker.setMap((region === 'all' || marker.region === region) ? map : null);
            });

            if (region === 'all') {
                accMarkers['namba'].setMap(map); accMarkers['kyoto'].setMap(map);
                map.setZoom(11); map.panTo(accMarkers['namba'].getPosition());
            } else {
                accMarkers['namba'].setMap(region === 'namba' ? map : null);
                accMarkers['kyoto'].setMap(region === 'kyoto' ? map : null);
                if (accMarkers[region]) {
                    map.panTo(accMarkers[region].getPosition()); map.setZoom(13);
                }
            }
        }

        // â˜…â˜…â˜… í•µì‹¬ ìˆ˜ì •: initMap í•¨ìˆ˜ë¥¼ ì „ì—­(window)ì— ë“±ë¡ â˜…â˜…â˜…
        // ì´ë ‡ê²Œ í•´ì•¼ êµ¬ê¸€ë§µì´ ë¡œë”© ëë‚˜ê³  "ì–´ë”” ìˆì–´?" í•˜ê³  ì°¾ì„ ë•Œ ë°”ë¡œ ë°œê²¬í•©ë‹ˆë‹¤.
        window.initMap = initMap;

    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADJIrnLeiIBYBiOzi795TNF3KRsZdgBwA&callback=initMap" async defer></script>
</body>
</html>